import cesium,GUI,echarts;
<div id="cesiumContainer">
  <div id="main" style="width: 600px;height:400px;display: none"></div>
</div>
<div class="toolBar">
  <button class="cesium-button" onclick="beginDraw()">开始绘制</button>
</div>
<script>
  let viewer = new Cesium.Viewer("cesiumContainer", {
    animation: false,
    baseLayerPicker: false,
    timeline: false,
    navigationHelpButton: false,
    geocoder: false,
    homeButton: false,
    sceneModePicker: false,
  });
  // 隐藏版权
  viewer._cesiumWidget._creditContainer.style.display = "none";

  // 添加cesium格化中国地形服务
  let terrainProvider = new Cesium.CesiumTerrainProvider({
    url: "http://data.marsgis.cn/terrain",
  });
  viewer.terrainProvider = terrainProvider;

  viewer.camera.setView({
    destination: Cesium.Cartesian3.fromDegrees(
      96.70456483909693,
      28.883444927447762,
      48977.26981733466
    ),
    orientation: {
      heading: Cesium.Math.toRadians(0),
      pitch: Cesium.Math.toRadians(-31),
    },
  });

  let dom = document.getElementById("main"); // 绘图对象
  let myChart = null;
  let start = null;
  let end = null;

  function drawPoint(position) {
    viewer.entities.add({
      position: position,
      point: {
        size: 1000,
        color: Cesium.Color.GREEN,
      },
    });
  }

  function drawLine() {
    viewer.entities.add({
      polyline: {
        positions: new Cesium.CallbackProperty(function() {
          return [start, end];
        }),
        material: Cesium.Color.RED,
        clampToGround: true,
        classificationType: Cesium.ClassificationType.BOTH,
      },
    });
  }

  function beginDraw() {
    // 重置
    dom.style.display = "none";
    viewer.entities.removeAll();
    start = null;
    end = null;
    document.body.style.cursor = "crosshair";
    viewer.screenSpaceEventHandler.setInputAction(function(clickEvent) {
      if (start == null) {
        start = viewer.scene.pickPosition(clickEvent.position);
        drawPoint(start);
        viewer.screenSpaceEventHandler.setInputAction(function(moveEvent) {
          end = viewer.scene.pickPosition(moveEvent.endPosition);
          drawLine();
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
      } else {
        end = viewer.scene.pickPosition(clickEvent.position);
        drawPoint(end);
        viewer.screenSpaceEventHandler.removeInputAction(
          Cesium.ScreenSpaceEventType.LEFT_CLICK
        );
        viewer.screenSpaceEventHandler.removeInputAction(
          Cesium.ScreenSpaceEventType.MOUSE_MOVE
        );
        profileAnalyse();
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
  }

  function profileAnalyse() {
    let positions = [Cesium.Cartographic.fromCartesian(start)];
    // 插值100个点，点越多模拟越精确，但是效率会低
    let count = 100;
    for (let i = 1; i < count; i++) {
      let cart = Cesium.Cartesian3.lerp(
        start,
        end,
        i / count,
        new Cesium.Cartesian3()
      );
      positions.push(Cesium.Cartographic.fromCartesian(cart));
    }
    positions.push(Cesium.Cartographic.fromCartesian(end));

    // 异步使用最精确的地形采样获取地形高度
    let promise = Cesium.sampleTerrainMostDetailed(terrainProvider, positions);
    Cesium.when(promise, function(updatedPositions) {
      // 处理返回的数据
      let height = [];
      for (let i = 0; i < updatedPositions.length; i++) {
        height.push(updatedPositions[i].height); // 取得高程值
      }

      // 绘制高程走势图
      dom.style.display = "block";

      // 使用Echart等图表工具可视化
      if (myChart == null) {
        myChart = echarts.init(dom);
        initChart(height, false);
      } else {
        initChart(height, true);
      }
    });
  }

  function initChart(height, isMerge) {
    let option = {
      title: {
        text: "海拔走势图",
      },
      tooltip: {
        trigger: "axis",
        axisPointer: {
          type: "cross",
          label: {
            backgroundColor: "#6a7985",
          },
        },
      },
      legend: {
        data: ["海拔走势图"],
      },
      toolbox: {
        feature: {
          saveAsImage: {},
        },
      },
      grid: {
        left: "3%",
        right: "4%",
        bottom: "3%",
        containLabel: true,
      },
      xAxis: [
        {
          type: "category",
          boundaryGap: false,
        },
      ],
      yAxis: [
        {
          type: "value",
        },
      ],
      series: [
        {
          name: "海拔走势图",
          type: "line",
          stack: "总量",
          label: {
            normal: {
              show: true,
              position: "top",
            },
          },
          areaStyle: { normal: {} },
          data: height,
        },
      ],
    };
    myChart.setOption(option, isMerge);
  }
</script>
<style>
  html,
  body,
  #cesiumContainer {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #000000;
  }

  #main {
    z-index: 1;
    position: absolute;
    top: 80px;
    left: 10px;
    background-color: white;
  }

  .toolBar {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #303336;
    opacity: 0.6;
    padding: 6px;
  }
</style>
