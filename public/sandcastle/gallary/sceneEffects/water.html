import cesium,GUI;
<div id="cesiumContainer"></div>
<script>
  const params = {
    show: true,
  };

  // let gui = new dat.GUI();
  // gui
  //   .add(params, "show")
  //   .onChange(() => {
  //     fogEffect.show(params.show);
  //   })
  //   .name("开启雾");
  // gui.open();

  let viewer = new Cesium.Viewer("cesiumContainer", {
    animation: false,
    baseLayerPicker: false,
    timeline: false,
    navigationHelpButton: false,
    geocoder: false,
    homeButton: false,
    sceneModePicker: false,
    navigationHelpButton: false,
  });
  // 隐藏版权
  viewer._cesiumWidget._creditContainer.style.display = "none";

  let waterPointArr = [
    123.12795180796876,
    30.92873036148444,
    123.21705180796876,
    30.18523036148444,
    123.03865180796875,
    28.81703036148444,
    122.68175180796875,
    27.47853036148444,
    121.96785180796876,
    26.79433036148444,
    120.89715180796875,
    26.79433036148444,
    120.46155180796875,
    27.14253036148444,
    120.46775180796875,
    27.14313036148444,
    120.49245180796875,
    27.13613036148444,
    120.52225180796876,
    27.14213036148444,
    120.54595180796875,
    27.15683036148444,
    120.55325180796875,
    27.173430361484442,
    120.55615180796875,
    27.204030361484442,
    120.56415180796876,
    27.22023036148444,
    120.57145180796876,
    27.228230361484442,
    120.57615180796876,
    27.24113036148444,
    120.55475180796876,
    27.25203036148444,
    120.55295180796875,
    27.25773036148444,
    120.56345180796875,
    27.27793036148444,
    120.57405180796876,
    27.28673036148444,
    120.57575180796876,
    27.29363036148444,
    120.57165180796875,
    27.30993036148444,
    120.58035180796875,
    27.321430361484442,
    120.61225180796875,
    27.33693036148444,
    120.65705180796876,
    27.35233036148444,
    120.67005180796875,
    27.36283036148444,
    120.67505180796876,
    27.382330361484442,
    120.67365180796875,
    27.41993036148444,
    120.67685180796875,
    27.431030361484442,
    120.69965180796875,
    27.46563036148444,
    120.70275180796875,
    27.47873036148444,
    120.68635180796875,
    27.49233036148444,
    120.67815180796875,
    27.516430361484442,
    120.66225180796876,
    27.51963036148444,
    120.64285180796875,
    27.55653036148444,
    120.63705180796875,
    27.56143036148444,
    120.63485180796876,
    27.577330361484442,
    120.65205180796875,
    27.58683036148444,
    120.67495180796875,
    27.60913036148444,
    120.68535180796876,
    27.623030361484442,
    120.70065180796875,
    27.66943036148444,
    120.70895180796876,
    27.682630361484442,
    120.73965180796876,
    27.70213036148444,
    120.76115180796876,
    27.717730361484442,
    120.79775180796875,
    27.77953036148444,
    120.81545180796876,
    27.777030361484442,
    120.85505180796875,
    27.822730361484442,
    120.91085180796875,
    27.86473036148444,
    120.94175180796876,
    27.89683036148444,
    120.95155180796876,
    27.895830361484443,
    120.97425180796876,
    27.88723036148444,
    121.01215180796875,
    27.84623036148444,
    121.02005180796876,
    27.83593036148444,
    121.02775180796876,
    27.83263036148444,
    121.06985180796875,
    27.83423036148444,
    121.08985180796876,
    27.81753036148444,
    121.10765180796875,
    27.813730361484442,
    121.13305180796876,
    27.81323036148444,
    121.15255180796875,
    27.815330361484442,
    121.14465180796876,
    27.806130361484442,
    121.12945180796875,
    27.79923036148444,
    121.13145180796876,
    27.78883036148444,
    121.14385180796876,
    27.79173036148444,
    121.15265180796875,
    27.810630361484442,
    121.18435180796875,
    27.81413036148444,
    121.19665180796875,
    27.83393036148444,
    121.20055180796875,
    27.85513036148444,
    121.19585180796875,
    27.86983036148444,
    121.18515180796875,
    27.87483036148444,
    121.16675180796875,
    27.87693036148444,
    121.16035180796875,
    27.88463036148444,
    121.16275180796875,
    27.90253036148444,
    121.15795180796876,
    27.91033036148444,
    121.13735180796876,
    27.90883036148444,
    121.11675180796875,
    27.89983036148444,
    121.09945180796875,
    27.89503036148444,
    121.07555180796875,
    27.894430361484442,
    121.05585180796875,
    27.90013036148444,
    120.99185180796876,
    27.94973036148444,
    121.01525180796875,
    27.98163036148444,
    121.02455180796875,
    28.00373036148444,
    121.03095180796875,
    28.03363036148444,
    121.03945180796875,
    28.05583036148444,
    121.05905180796876,
    28.09633036148444,
    121.07085180796875,
    28.11053036148444,
    121.09015180796875,
    28.12713036148444,
    121.10845180796875,
    28.13903036148444,
    121.12115180796876,
    28.12523036148444,
    121.13525180796876,
    28.07053036148444,
    121.13585180796875,
    28.05063036148444,
    121.14095180796875,
    28.03143036148444,
    121.14975180796876,
    28.02533036148444,
    121.17615180796875,
    28.022330361484443,
    121.23865180796875,
    28.02883036148444,
    121.26115180796876,
    28.03443036148444,
    121.28225180796875,
    28.054630361484442,
    121.29785180796875,
    28.06443036148444,
    121.30745180796875,
    28.08853036148444,
    121.30805180796875,
    28.10053036148444,
    121.30315180796875,
    28.11503036148444,
    121.29155180796876,
    28.13173036148444,
    121.28885180796875,
    28.147530361484442,
    121.29625180796876,
    28.15193036148444,
    121.31335180796876,
    28.15013036148444,
    121.33345180796876,
    28.14053036148444,
    121.34315180796875,
    28.12743036148444,
    121.36125180796876,
    28.126130361484442,
    121.37215180796875,
    28.13133036148444,
    121.37775180796875,
    28.15033036148444,
    121.39135180796875,
    28.15913036148444,
    121.40235180796876,
    28.19733036148444,
    121.41955180796876,
    28.21803036148444,
    121.44645180796876,
    28.23863036148444,
    121.45605180796875,
    28.25033036148444,
    121.45975180796876,
    28.27183036148444,
    121.47765180796875,
    28.28433036148444,
    121.48875180796875,
    28.301430361484442,
    121.49935180796875,
    28.305930361484442,
    121.52595180796875,
    28.30363036148444,
    121.56435180796875,
    28.28803036148444,
    121.57145180796876,
    28.27943036148444,
    121.57195180796876,
    28.258730361484442,
    121.57955180796876,
    28.24183036148444,
    121.62425180796875,
    28.25053036148444,
    121.63425180796875,
    28.25943036148444,
    121.63705180796875,
    28.26973036148444,
    121.64905180796875,
    28.27833036148444,
    121.64565180796875,
    28.29663036148444,
    121.65695180796875,
    28.31863036148444,
    121.66935180796875,
    28.333330361484443,
    121.67265180796875,
    28.34783036148444,
    121.66645180796876,
    28.344130361484442,
    121.66035180796875,
    28.35563036148444,
    121.63585180796875,
    28.34753036148444,
    121.63655180796876,
    28.359530361484442,
    121.64645180796876,
    28.36513036148444,
    121.65885180796874,
    28.37843036148444,
    121.65895180796875,
    28.39243036148444,
    121.68715180796875,
    28.40093036148444,
    121.69275180796875,
    28.40733036148444,
    121.69185180796875,
    28.41843036148444,
    121.68195180796876,
    28.440330361484442,
    121.66455180796875,
    28.444830361484442,
    121.67115180796876,
    28.47263036148444,
    121.66785180796876,
    28.485730361484443,
    121.65265180796875,
    28.502630361484442,
    121.64225180796875,
    28.520830361484443,
    121.63905180796876,
    28.54913036148444,
    121.63425180796875,
    28.56273036148444,
    121.61505180796875,
    28.57173036148444,
    121.59615180796875,
    28.57523036148444,
    121.58625180796875,
    28.586530361484442,
    121.56885180796876,
    28.62653036148444,
    121.55705180796875,
    28.64503036148444,
    121.54085180796875,
    28.65563036148444,
    121.58735180796876,
    28.67223036148444,
    121.64635180796876,
    28.68283036148444,
    121.67915180796875,
    28.69893036148444,
    121.68945180796875,
    28.719130361484442,
    121.69455180796875,
    28.77283036148444,
    121.70475180796875,
    28.804630361484442,
    121.70285180796876,
    28.82523036148444,
    121.69225180796874,
    28.85523036148444,
    121.68735180796875,
    28.86333036148444,
    121.66005180796876,
    28.86963036148444,
    121.66835180796875,
    28.872930361484443,
    121.70425180796875,
    28.86363036148444,
    121.73865180796875,
    28.85663036148444,
    121.75905180796875,
    28.85593036148444,
    121.77465180796875,
    28.863930361484442,
    121.77645180796875,
    28.87983036148444,
    121.77205180796875,
    28.89833036148444,
    121.74335180796875,
    28.95423036148444,
    121.71835180796876,
    28.97043036148444,
    121.71125180796875,
    28.986030361484442,
    121.71535180796876,
    29.01223036148444,
    121.71265180796875,
    29.02893036148444,
    121.69945180796876,
    29.04003036148444,
    121.65895180796875,
    29.05853036148444,
    121.65195180796876,
    29.075930361484442,
    121.65535180796876,
    29.092730361484442,
    121.66155180796875,
    29.10613036148444,
    121.65995180796875,
    29.11833036148444,
    121.61655180796875,
    29.14353036148444,
    121.60845180796875,
    29.16913036148444,
    121.64885180796875,
    29.15093036148444,
    121.71555180796875,
    29.12493036148444,
    121.74995180796876,
    29.13673036148444,
    121.76805180796875,
    29.16673036148444,
    121.76935180796875,
    29.14823036148444,
    121.78055180796875,
    29.10963036148444,
    121.79425180796875,
    29.10523036148444,
    121.81115180796876,
    29.10993036148444,
    121.82705180796876,
    29.101830361484442,
    121.84235180796875,
    29.08833036148444,
    121.86005180796874,
    29.08643036148444,
    121.88445180796876,
    29.10543036148444,
    121.89805180796876,
    29.10393036148444,
    121.90965180796876,
    29.08583036148444,
    121.89945180796875,
    29.07643036148444,
    121.90385180796875,
    29.06903036148444,
    121.93155180796876,
    29.07073036148444,
    121.93505180796875,
    29.05183036148444,
    121.95165180796876,
    29.04743036148444,
    121.96615180796876,
    29.05283036148444,
    121.96985180796875,
    29.075930361484442,
    121.98435180796875,
    29.08693036148444,
    121.98335180796875,
    29.09143036148444,
    121.96875180796876,
    29.09303036148444,
    121.98335180796875,
    29.10123036148444,
    121.98855180796875,
    29.111030361484442,
    121.98535180796875,
    29.13763036148444,
    121.97925180796875,
    29.14483036148444,
    121.98825180796875,
    29.14923036148444,
    121.98665180796876,
    29.15483036148444,
    121.97145180796875,
    29.16333036148444,
    121.96045180796875,
    29.170530361484442,
    121.94915180796875,
    29.18333036148444,
    121.93725180796875,
    29.18283036148444,
    121.94865180796876,
    29.193230361484442,
    121.97185180796875,
    29.193330361484442,
    121.97745180796875,
    29.22413036148444,
    121.96805180796875,
    29.24393036148444,
    121.96835180796876,
    29.25003036148444,
    121.99095180796876,
    29.26083036148444,
    122.00195180796875,
    29.260130361484443,
    121.99855180796875,
    29.26613036148444,
    122.00025180796875,
    29.27883036148444,
    121.98105180796875,
    29.28413036148444,
    121.96755180796875,
    29.28143036148444,
    121.94485180796875,
    29.28423036148444,
    121.94085180796876,
    29.298230361484443,
    121.94655180796875,
    29.316730361484442,
    121.95835180796875,
    29.33433036148444,
    121.95205180796876,
    29.344130361484442,
    121.93595180796875,
    29.34813036148444,
    121.93225180796875,
    29.353430361484442,
    121.93855180796875,
    29.36953036148444,
    121.93765180796875,
    29.38413036148444,
    121.94585180796875,
    29.39533036148444,
    121.95965180796875,
    29.40713036148444,
    121.97555180796876,
    29.41113036148444,
    121.98145180796875,
    29.42993036148444,
    121.99175180796875,
    29.44593036148444,
    121.99205180796875,
    29.46143036148444,
    121.97315180796875,
    29.47803036148444,
    121.96665180796876,
    29.50653036148444,
    121.96895180796875,
    29.51563036148444,
    121.98645180796875,
    29.54123036148444,
    121.99505180796875,
    29.54513036148444,
    121.98575180796875,
    29.563730361484442,
    121.98715180796876,
    29.57063036148444,
    122.00025180796875,
    29.58243036148444,
    121.99975180796875,
    29.59373036148444,
    121.98535180796875,
    29.606330361484442,
    121.96605180796875,
    29.63583036148444,
    121.93755180796876,
    29.64253036148444,
    121.92345180796875,
    29.65163036148444,
    121.90955180796875,
    29.65013036148444,
    121.89385180796876,
    29.63653036148444,
    121.87245180796876,
    29.63253036148444,
    121.85895180796875,
    29.636630361484443,
    121.83355180796875,
    29.65313036148444,
    121.86325180796875,
    29.67923036148444,
    121.90645180796875,
    29.719230361484442,
    121.92555180796876,
    29.74123036148444,
    121.93755180796876,
    29.74853036148444,
    121.95915180796875,
    29.75003036148444,
    121.99785180796876,
    29.760130361484443,
    122.01945180796875,
    29.78063036148444,
    122.03755180796875,
    29.813730361484442,
    122.04855180796875,
    29.82603036148444,
    122.08475180796876,
    29.84453036148444,
    122.10225180796876,
    29.85963036148444,
    122.13595180796875,
    29.87223036148444,
    122.14305180796875,
    29.877730361484442,
    122.14015180796875,
    29.90173036148444,
    122.11675180796875,
    29.90993036148444,
    122.09625180796876,
    29.905030361484442,
    122.08015180796875,
    29.89263036148444,
    122.00975180796875,
    29.89113036148444,
    122.00345180796876,
    29.899030361484442,
    122.00285180796875,
    29.923230361484443,
    121.99455180796875,
    29.93463036148444,
    121.98435180796875,
    29.93763036148444,
    121.98175180796875,
    29.94703036148444,
    121.96805180796875,
    29.95653036148444,
    121.95285180796876,
    29.95073036148444,
    121.92715180796876,
    29.931130361484442,
    121.91955180796876,
    29.92083036148444,
    121.90185180796875,
    29.92363036148444,
    121.85995180796876,
    29.94403036148444,
    121.83515180796876,
    29.95793036148444,
    121.81435180796875,
    29.97433036148444,
    121.78405180796875,
    29.993530361484442,
    121.77145180796876,
    29.994930361484442,
    121.72495180796875,
    29.99223036148444,
    121.69975180796875,
    30.00803036148444,
    121.66745180796875,
    30.04883036148444,
    121.63535180796875,
    30.069830361484442,
    121.62605180796875,
    30.07773036148444,
    121.61135180796876,
    30.10993036148444,
    121.59165180796876,
    30.14353036148444,
    121.56145180796875,
    30.184130361484442,
    121.52755180796875,
    30.22493036148444,
    121.49775180796875,
    30.258630361484443,
    121.47625180796875,
    30.27943036148444,
    121.45265180796875,
    30.298530361484442,
    121.39505180796876,
    30.33843036148444,
    121.37185180796875,
    30.37093036148444,
    121.32805180796875,
    30.39713036148444,
    121.27875180796875,
    30.405030361484442,
    121.22545180796875,
    30.40463036148444,
    121.18325180796876,
    30.43433036148444,
    121.13015180796876,
    30.48013036148444,
    121.09315180796875,
    30.51583036148444,
    121.07155180796875,
    30.54273036148444,
    121.05835180796875,
    30.56403036148444,
    121.08535180796875,
    30.57523036148444,
    121.11645180796876,
    30.58553036148444,
    121.12765180796875,
    30.59363036148444,
    121.14925180796875,
    30.600030361484443,
    121.15085180796875,
    30.61183036148444,
    121.17265180796875,
    30.62583036148444,
    121.18885180796875,
    30.63303036148444,
    121.22105180796875,
    30.639830361484442,
    121.23165180796875,
    30.644130361484443,
    121.24495180796875,
    30.654830361484443,
    121.25725180796876,
    30.67273036148444,
    121.27465180796875,
    30.67753036148444,
    121.36215180796876,
    30.67973036148444,
    121.94365180796875,
    30.77693036148444,
    122.18715180796875,
    30.906530361484442,
    122.40765180796875,
    30.90103036148444,
    123.12795180796876,
    30.92873036148444,
  ];

  class WaterEffect {
    /**
     * @param waterPointArr - 水面点数组
     * @param frequency - 频率,默认6000
     * @param animationSpeed - 动画速度，默认0.01
     * @param waterColor - 基础水色
     * @param blendColor - blend颜色
     */
    constructor(viewer, options) {
      if (!viewer) throw new Error("no viewer object!");
      options = options || {};
      this.waterPointArr = Cesium.defaultValue(options.waterPointArr, []);
      this.frequency = Cesium.defaultValue(options.frequency, 6000);
      this.animationSpeed = Cesium.defaultValue(options.animationSpeed, 0.01);
      this.amplitude = Cesium.defaultValue(options.amplitude, 8.0);
      this.waterColor = Cesium.defaultValue(
        options.waterColor,
        new Cesium.Color(0.05, 0.1, 0.3, 1)
      );
      this.blendColor = Cesium.defaultValue(
        options.blendColor,
        new Cesium.Color(0.05, 0.1, 0.3, 0.2)
      );
      this.viewer = viewer;
      this.init();
    }

    init() {
      this.waterRiver = this.viewer.scene.primitives.add(
        new Cesium.GroundPrimitive({
          geometryInstances: new Cesium.GeometryInstance({
            geometry: new Cesium.PolygonGeometry({
              polygonHierarchy: new Cesium.PolygonHierarchy(
                Cesium.Cartesian3.fromDegreesArray(this.waterPointArr)
              ),
            }),
          }),
          appearance: new Cesium.EllipsoidSurfaceAppearance({
            renderState: {
              cull: {
                enabled: true,
              },
            },
          }),
        })
      );

      this.waterRiver.appearance.material = new Cesium.Material({
        fabric: {
          type: "Water",
          uniforms: {
            normalMap: "../sandcastle/data/imgs/waterNormals.jpg",
            frequency: this.frequency,
            animationSpeed: this.animationSpeed,
            amplitude: this.amplitude,
            baseWaterColor: this.waterColor,
            blendColor: this.blendColor,
            // specularIntensity: 0.5
          },
        },
      });

      this.waterRiver.appearance.material.shaderSource = this.FS_Water();
    }

    FS_Water() {
      return (
        "uniform sampler2D specularMap_6;\n" +
        "uniform sampler2D normalMap_0;\n" +
        "uniform vec4 baseWaterColor_4;\n" +
        "uniform vec4 blendColor_5;\n" +
        "uniform float frequency_1;\n" +
        "uniform float animationSpeed_2;\n" +
        "uniform float amplitude_3;\n" +
        "uniform float specularIntensity_7;\n" +
        "uniform float fadeFactor_8;\n" +
        "czm_material czm_getMaterial(czm_materialInput materialInput)\n" +
        "{\n" +
        "  czm_material material = czm_getDefaultMaterial(materialInput);\n" +
        "  float time = czm_frameNumber * animationSpeed_2;\n" +
        "  float fade = max(1.0, (length(materialInput.positionToEyeEC) / 10000000000.0) * frequency_1 * fadeFactor_8);\n" +
        "  float specularMapValue = texture2D(specularMap_6, materialInput.st).r;\n" +
        "  vec4 noise = czm_getWaterNoise(normalMap_0, materialInput.st * frequency_1, time, 0.0);\n" +
        "  vec3 normalTangentSpace = noise.xyz * vec3(1.0, 1.0, (1.0 / amplitude_3));\n" +
        "  normalTangentSpace.xy /= fade;\n" +
        "  normalTangentSpace = mix(vec3(0.0, 0.0, 50.0), normalTangentSpace, specularMapValue);\n" +
        "  normalTangentSpace = normalize(normalTangentSpace);\n" +
        "  float tsPerturbationRatio = clamp(dot(normalTangentSpace, vec3(0.0, 0.0, 1.0)), 0.0, 1.0);\n" +
        "  material.alpha = specularMapValue*0.1;\n" +
        "  const vec3 waveHighlightColor = vec3(0.3, 0.45, 0.6);\n" +
        "  float diffuseIntensity = czm_getLambertDiffuse(czm_sunDirectionEC, materialInput.positionToEyeEC) * specularMapValue;\n" +
        "  vec3 diffuseHighlight = waveHighlightColor * diffuseIntensity * (1.0 - fadeFactor_8);\n" +
        "  vec3 nonDiffuseHighlight = mix(waveHighlightColor * 5.0 * (1.0 - tsPerturbationRatio), vec3(0.0), diffuseIntensity);\n" +
        "  vec3 diffuseColor = baseWaterColor_4.rgb + diffuseHighlight + nonDiffuseHighlight;\n" +
        "  material.diffuse = mix(blendColor_5.rgb, diffuseColor, specularMapValue);\n" +
        "  material.diffuse += (0.1 * tsPerturbationRatio);\n" +
        "  material.diffuse = material.diffuse;\n" +
        "  material.normal = normalize(materialInput.tangentToEyeMatrix * normalTangentSpace);\n" +
        "  material.specular = specularIntensity_7;\n" +
        "  material.shininess = 10.0;\n" +
        "  return material;\n" +
        "}"
      );
    }
  }

  Cesium.WaterEffect = WaterEffect;

  let waterEffect = new Cesium.WaterEffect(viewer, {
    waterPointArr,
  });

  viewer.camera.setView({
    destination: Cesium.Cartesian3.fromDegrees(
      122.18325180796876,
      29.43433036148444,
      4000
    ),
    orientation: {
      heading: Cesium.Math.toRadians(6.138290901269638),
      pitch: Cesium.Math.toRadians(-9.4205526295335225),
    },
  });
</script>
<style>
  #cesiumContainer {
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
</style>
